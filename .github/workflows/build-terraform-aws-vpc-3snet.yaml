name: AWS-terraform-1-vpc-3-subnet
on:
  push:
    branches:
      - main

permissions:
  id-token: write # Required for AWS OIDC connection
  contents: read # Required for actions/checkout
  pull-requests: write # Required for GitHub bot to comment on PR
  issues: write # Required for posting plan results as issue comments

env:
  TF_LOG: INFO
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TERRAFORM_VERSION: 1.11.0

jobs:
  terraform:
    name: 'AWS-terraform-1-vpc-3-subnet'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .
    
    steps:
    # ğŸ” PREPARATION PHASE - Repository checkout and environment setup
    - name: ğŸ” Checkout repository
      uses: actions/checkout@v4
      id: checkout
    
    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      id: setup
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      id: aws-credentials
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ secrets.AWS_REGION }}
        role-session-name: GitHubActions
    
    # ğŸš€ INITIALIZATION PHASE - Initialize and validate Terraform
    - name: ğŸš€ Initialize Terraform
      id: init
      working-directory: infrastructure
      run: |
        echo "::group::Terraform Initialization"
        echo "ğŸ”„ Starting Terraform initialization..."
        
        # Initialize with state migration enabled
        if terraform init -migrate-state; then
          echo "âœ… Terraform initialization successful"
          echo "init_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Terraform initialization failed"
          echo "init_status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"

    - name: ğŸ” Validate Terraform Configuration
      id: validate
      working-directory: infrastructure
      if: steps.init.outputs.init_status == 'success'
      run: |
        echo "::group::Terraform Validation"
        echo "ğŸ”„ Validating Terraform configuration..."
        
        # Validate Terraform configuration
        if terraform validate; then
          echo "âœ… Terraform validation successful"
          echo "validate_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Terraform validation failed"
          echo "validate_status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"
    
    # ğŸ“ PLANNING PHASE - Generate and display plan
    - name: ğŸ“ Create Terraform Plan
      id: plan
      working-directory: infrastructure
      if: steps.validate.outputs.validate_status == 'success'
      run: |
       echo "ğŸ”„ Generating Terraform plan..."
       if terraform plan -out=./plans/tfplan.binary -detailed-exitcode -input=false ; then
        echo "âœ… Terraform plan generated successfully"
        echo "plan_status=success" >> $GITHUB_OUTPUT
        echo "plan_exitcode=${PLAN_EXIT_CODE}" >> $GITHUB_OUTPUT
        else
        echo "âŒ Terraform plan generation failed"


  
  