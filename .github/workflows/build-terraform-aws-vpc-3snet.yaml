name: AWS-terraform-1-vpc-3-subnet
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  id-token: write # Required for AWS OIDC connection
  contents: read # Required for actions/checkout
  pull-requests: write # Required for GitHub bot to comment on PR
  issues: write # Required for posting plan results as issue comments

env:
  TF_LOG: INFO
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TERRAFORM_VERSION: 1.11.0

jobs:
  terraform:
    name: 'Terraform Deployment'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .
    
    steps:
    # 🔍 PREPARATION PHASE - Repository checkout and environment setup
    - name: 🔍 Checkout repository
      uses: actions/checkout@v4
      id: checkout
    
    - name: 🔧 Setup Terraform
      uses: hashicorp/setup-terraform@v2
      id: setup
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

    - name: 🔐 Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      id: aws-credentials
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ secrets.AWS_REGION }}
        role-session-name: GitHubActions
    
    # 🚀 INITIALIZATION PHASE - Initialize and validate Terraform
    - name: 🚀 Initialize Terraform
      id: init
      working-directory: infrastructure
      run: |
        echo "::group::Terraform Initialization"
        echo "🔄 Starting Terraform initialization..."
        
        # Initialize with state migration enabled
        if terraform init -migrate-state; then
          echo "✅ Terraform initialization successful"
          echo "init_status=success" >> $GITHUB_OUTPUT
        else
          echo "❌ Terraform initialization failed"
          echo "init_status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"

    - name: 🔍 Validate Terraform Configuration
      id: validate
      working-directory: infrastructure
      if: steps.init.outputs.init_status == 'success'
      run: |
        echo "::group::Terraform Validation"
        echo "🔄 Validating Terraform configuration..."
        
        # Validate Terraform configuration
        if terraform validate; then
          echo "✅ Terraform validation successful"
          echo "validate_status=success" >> $GITHUB_OUTPUT
        else
          echo "❌ Terraform validation failed"
          echo "validate_status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"
    
    # 📝 PLANNING PHASE - Generate and display plan
    - name: 📝 Create Terraform Plan
      id: plan
      working-directory: infrastructure
      if: steps.validate.outputs.validate_status == 'success'
      run: |
        echo "::group::Terraform Plan Generation"
        echo "🔄 Generating Terraform plan..."
        
        # Create plan file
        mkdir -p ./plans
        
        # Run plan and capture output
        if terraform plan -out=./plans/tfplan.binary -detailed-exitcode -input=false > ./plans/plan_output.txt 2>&1; then
          PLAN_EXIT_CODE=$?
          echo "✅ Terraform plan generated successfully"
          echo "plan_status=success" >> $GITHUB_OUTPUT
          echo "plan_exitcode=${PLAN_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Convert binary plan to JSON for easier parsing
          terraform show -json ./plans/tfplan.binary > ./plans/tfplan.json
          
          # Create human-readable summary
          echo "## Terraform Plan Summary" > ./plans/plan_summary.md
          echo "📅 Generated on: $(date)" >> ./plans/plan_summary.md
          echo "" >> ./plans/plan_summary.md
          
          # Count resources being added/changed/destroyed
          RESOURCES_ADD=$(grep -c "will be created" ./plans/plan_output.txt || echo "0")
          RESOURCES_CHANGE=$(grep -c "will be updated in-place" ./plans/plan_output.txt || echo "0")
          RESOURCES_DESTROY=$(grep -c "will be destroyed" ./plans/plan_output.txt || echo "0")
          
          echo "🟢 Resources to add: ${RESOURCES_ADD}" >> ./plans/plan_summary.md
          echo "🟠 Resources to change: ${RESOURCES_CHANGE}" >> ./plans/plan_summary.md
          echo "🔴 Resources to destroy: ${RESOURCES_DESTROY}" >> ./plans/plan_summary.md
          echo "" >> ./plans/plan_summary.md
          
          # Add S3 bucket specific information
          echo "### S3 Bucket Details" >> ./plans/plan_summary.md
          echo "\`\`\`" >> ./plans/plan_summary.md
          grep -A 20 "aws_s3_bucket" ./plans/plan_output.txt >> ./plans/plan_summary.md || echo "No S3 bucket found in plan" >> ./plans/plan_summary.md
          echo "\`\`\`" >> ./plans/plan_summary.md
          
          cat ./plans/plan_summary.md
        else
          echo "❌ Terraform plan generation failed"
          echo "plan_status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"

    # 📊 REPORTING PHASE - Share plan results
    - name: 📊 Post Plan Summary to PR
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request' && steps.plan.outputs.plan_status == 'success'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const planSummary = fs.readFileSync('./infrastructure/plans/plan_summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: planSummary
          });

    - name: 📨 Upload Plan to Artifact Storage
      uses: actions/upload-artifact@v3
      if: steps.plan.outputs.plan_status == 'success'
      with:
        name: terraform-plan
        path: |
          infrastructure/plans/
        retention-days: 14
        
    - name: 📤 Upload Plan Output to S3 Bucket
      id: s3-upload
      if: steps.plan.outputs.plan_status == 'success'
      run: |
        echo "::group::S3 Plan Upload"
        echo "🔄 Uploading Terraform plan to S3 bucket..."
        
        # Create a timestamp for unique folder naming
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Create a tar.gz archive of all plan files
        cd infrastructure
        tar -czf terraform-plan-${TIMESTAMP}.tar.gz ./plans/
        
        # Upload to S3
        if aws s3 cp terraform-plan-${TIMESTAMP}.tar.gz s3://devops-statefile-david-site-project-1234567/plan\ output/terraform-plan-${TIMESTAMP}.tar.gz; then
          echo "✅ Successfully uploaded plan to S3 bucket"
          echo "s3_upload_status=success" >> $GITHUB_OUTPUT
          echo "s3_path=s3://devops-statefile-david-site-project-1234567/plan output/terraform-plan-${TIMESTAMP}.tar.gz" >> $GITHUB_OUTPUT
        else
          echo "❌ Failed to upload plan to S3 bucket"
          echo "s3_upload_status=failed" >> $GITHUB_OUTPUT
          # Continue workflow even if S3 upload fails
        fi
        echo "::endgroup::"

   
    
  