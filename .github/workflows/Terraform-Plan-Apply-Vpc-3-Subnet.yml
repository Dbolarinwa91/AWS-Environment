name: Terraform-Apply-AWS-VPC-3-Subnets
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

permissions:
  id-token: write  # Required for AWS OIDC connection
  contents: read   # Required for actions/checkout

env:
  TF_LOG: INFO
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TERRAFORM_VERSION: ${{ secrets.TERRAFORM_VERSION }}
  TF_WORKING_DIR: infrastructure

jobs:
  # PHASE 1: PREPARE
  prepare:
    name: 'üîç Prepare Environment'
    runs-on: ubuntu-latest
    outputs:
      environment_ready: ${{ steps.env_check.outputs.environment_ready }}
    
    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions
      
      - name: ‚úÖ Verify Environment
        id: env_check
        run: |
          echo "Verifying environment setup..."
          terraform --version
          aws sts get-caller-identity
          echo "environment_ready=true" >> $GITHUB_OUTPUT

  # PHASE 2: VALIDATE
  validate:
    name: 'üß™ Validate Infrastructure'
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.environment_ready == 'true'
    outputs:
      validate_status: ${{ steps.validate.outputs.validate_status }}
    
    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions
      
      - name: üöÄ Initialize Terraform
        id: init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "::group::Terraform Initialization"
          echo "üîÑ Starting Terraform initialization..."
          
          # Initialize with state migration enabled
          if terraform init -migrate-state; then
            echo "‚úÖ Terraform initialization successful"
            echo "init_status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Terraform initialization failed"
            echo "init_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"

      - name: üîç Validate Terraform Configuration
        id: validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        if: steps.init.outputs.init_status == 'success'
        run: |
          echo "::group::Terraform Validation"
          echo "üîÑ Validating Terraform configuration..."
          
          # Validate Terraform configuration
          if terraform validate; then
            echo "‚úÖ Terraform validation successful"
            echo "validate_status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Terraform validation failed"
            echo "validate_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"

  # PHASE 3: PLAN
  plan:
    name: 'üìù Plan Infrastructure Changes'
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.validate_status == 'success'
    outputs:
      plan_status: ${{ steps.plan.outputs.plan_status }}
      has_changes: ${{ steps.plan.outputs.has_changes }}
    
    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions
      
      - name: üöÄ Initialize Terraform
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -migrate-state
      
      - name: üìù Create Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
              echo "::group::Terraform Plan Generation"
                      echo "üîÑ Generating Terraform plan..."

                      # Create plan directory
                      mkdir -p ./plans

                      # Run plan and capture output while also displaying it
                      terraform plan -out=./plans/tfplan.binary -detailed-exitcode -input=false 2>&1 | tee ./plans/plan_output.txt
                      PLAN_EXIT_CODE=${PIPESTATUS[0]}

                      echo "‚úÖ Terraform plan generated with exit code: ${PLAN_EXIT_CODE}"
                      echo "plan_status=success" >> $GITHUB_OUTPUT
                      
                      # Check for changes by looking directly at the plan output rather than just exit code
                      # Check for changes by looking directly at the plan output
                      if grep -q "Plan: 0 to add, 0 to change, 0 to destroy" ./plans/plan_output.txt; then
                        echo "No changes detected"
                        echo "has_changes=false" >> $GITHUB_OUTPUT
                      else
                        # Extract the numbers of resources to add, change, and destroy
                        RESOURCES_ADD=$(grep -o "Plan:.*" ./plans/plan_output.txt | grep -o "[0-9]\+ to add" | grep -o "[0-9]\+" || echo "0")
                        RESOURCES_CHANGE=$(grep -o "Plan:.*" ./plans/plan_output.txt | grep -o "[0-9]\+ to change" | grep -o "[0-9]\+" || echo "0")
                        RESOURCES_DESTROY=$(grep -o "Plan:.*" ./plans/plan_output.txt | grep -o "[0-9]\+ to destroy" | grep -o "[0-9]\+" || echo "0")
                        
                        echo "Resources to add: ${RESOURCES_ADD}"
                        echo "Resources to change: ${RESOURCES_CHANGE}"
                        echo "Resources to destroy: ${RESOURCES_DESTROY}"
                        
                        # Check if any resources are being added, changed, or destroyed
                        if [ "$RESOURCES_ADD" -gt "0" ] || [ "$RESOURCES_CHANGE" -gt "0" ] || [ "$RESOURCES_DESTROY" -gt "0" ]; then
                          echo "Changes detected"
                          echo "has_changes=true" >> $GITHUB_OUTPUT
                        else
                          echo "No changes detected"
                          echo "has_changes=false" >> $GITHUB_OUTPUT
                        fi
                      fi

                      echo "üü¢ Resources to add: ${RESOURCES_ADD}" >> ./plans/plan_summary.md
                      echo "üü† Resources to change: ${RESOURCES_CHANGE}" >> ./plans/plan_summary.md
                      echo "üî¥ Resources to destroy: ${RESOURCES_DESTROY}" >> ./plans/plan_summary.md
                      echo "" >> ./plans/plan_summary.md

                      # Also print the summary to the logs
                      echo "::group::Terraform Plan Summary"
                      echo "üü¢ Resources to add: ${RESOURCES_ADD}"
                      echo "üü† Resources to change: ${RESOURCES_CHANGE}"
                      echo "üî¥ Resources to destroy: ${RESOURCES_DESTROY}"
                      echo "::endgroup::"

                      echo "::endgroup::"
      - name: üìù Upload Plan Artifacts
        uses: actions/upload-artifact@v4
        if: steps.plan.outputs.plan_status == 'success'
        with:
          name: terraform-plans
          path: ${{ env.TF_WORKING_DIR }}/plans/
          retention-days: 5
      
      - name: üö´ No Changes Required
        if: steps.plan.outputs.has_changes == 'false'
        run: |
          echo "::group::No Changes"
          echo "‚úÖ Infrastructure is up to date"
          echo "No changes needed to be applied."
          echo "::endgroup::"

  # PHASE 4: APPLY (Only if changes detected)
  apply:
    name: 'üöÄ Apply Infrastructure Changes'
    runs-on: ubuntu-latest
    needs: plan
    if: needs.plan.outputs.has_changes == 'true'
    outputs:
      apply_status: ${{ steps.apply.outputs.apply_status }}
    
    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformApply
      
      - name: üöÄ Initialize Terraform
        id: init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "::group::Terraform Initialization"
          echo "üîÑ Starting Terraform initialization..."
          
          if terraform init -migrate-state; then
            echo "‚úÖ Terraform initialization successful"
          else
            echo "‚ùå Terraform initialization failed"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: üîÑ Apply Terraform Changes
        id: apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "::group::Terraform Apply"
          echo "üîÑ Applying Terraform changes..."  
          
          if terraform apply -auto-approve; then
            echo "‚úÖ Terraform apply successful"
            echo "apply_status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Terraform apply failed"
            echo "apply_status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"

  # PHASE 5: NOTIFICATION
  notify:
    name: 'üì¢ Send Notifications'
    runs-on: ubuntu-latest
    needs: [prepare, validate, plan, apply]
    if: always()
    
    steps:
      - name: üìä Workflow Summary
        run: |
          echo "## Terraform Workflow Summary" > $GITHUB_STEP_SUMMARY
          echo "üìÖ Run completed at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status by Phase:" >> $GITHUB_STEP_SUMMARY
          echo "- üîç Prepare: ${{ needs.prepare.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üß™ Validate: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üìù Plan: ${{ needs.plan.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.plan.result }}" == "success" ]]; then
            if [[ "${{ needs.plan.outputs.has_changes }}" == "true" ]]; then
              echo "  - Changes detected: YES" >> $GITHUB_STEP_SUMMARY
              echo "- üöÄ Apply: ${{ needs.apply.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - Changes detected: NO" >> $GITHUB_STEP_SUMMARY
              echo "- üöÄ Apply: skipped (no changes)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.apply.result }}" == "success" ]]; then
            echo "### üü¢ Infrastructure Successfully Updated" >> $GITHUB_STEP_SUMMARY
            echo "The Terraform infrastructure has been successfully applied." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.plan.outputs.has_changes }}" == "false" && "${{ needs.plan.result }}" == "success" ]]; then
            echo "### üü¢ Infrastructure Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "No changes were needed. All resources are already in the desired state." >> $GITHUB_STEP_SUMMARY
          else
            echo "### üî¥ Workflow Completed with Issues" >> $GITHUB_STEP_SUMMARY
            echo "Please check the job logs for details on what went wrong." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üì¢ Notify on Success
        if: |
          (needs.apply.result == 'success') || 
          (needs.plan.result == 'success' && needs.plan.outputs.has_changes == 'false')
        run: |
          echo "::group::Notification"
          echo "‚úÖ Workflow completed successfully!"
          
          if [[ "${{ needs.plan.outputs.has_changes }}" == "true" ]]; then
            echo "## üöÄ Infrastructure Successfully Updated"
            echo "The Terraform infrastructure has been successfully applied."
          else
            echo "## ‚úì Infrastructure Up to Date"
            echo "No changes were needed. All resources are already in the desired state."
          fi
          
          echo "Completed at: $(date)"
          echo "::endgroup::"
      
      - name: üì¢ Notify on Failure
        if: |
          needs.prepare.result == 'failure' || 
          needs.validate.result == 'failure' || 
          needs.plan.result == 'failure' || 
          needs.apply.result == 'failure'
        run: |
          echo "::group::Notification"
          echo "‚ùå Workflow failed!"
          
          if [[ "${{ needs.prepare.result }}" == "failure" ]]; then
            echo "## ‚ö†Ô∏è Environment Preparation Failed"
          elif [[ "${{ needs.validate.result }}" == "failure" ]]; then
            echo "## ‚ö†Ô∏è Terraform Validation Failed"
          elif [[ "${{ needs.plan.result }}" == "failure" ]]; then
            echo "## ‚ö†Ô∏è Terraform Plan Failed"
          elif [[ "${{ needs.apply.result }}" == "failure" ]]; then
            echo "## ‚ö†Ô∏è Terraform Apply Failed"
          fi
          
          echo "Please check the logs for detailed error information."
          echo "Failure occurred at: $(date)"
          echo "::endgroup::"